<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Bright Credit</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/full-slider.css" rel="stylesheet">

    <style>
      .vertical-center {
        min-height: 100%;  /* Fallback for browsers do NOT support vh unit */
        min-height: 100vh; /* These two lines are counted as one :-)       */

        display: flex;
        align-items: center;
      }
      .search_form {
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 55%;
        margin: auto;
        height: 200px;
        text-align: center;
        position: absolute;
    }

    h1 {
      color: #fff;
      font-size: 50px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .description {
      margin-top: 10px;
      margin-bottom: 20px;
    }

    .search {
    -webkit-box-shadow: gray;
    box-shadow: gray;
    border: 0px;
    font-size: 16px;
    padding: 13px 30px;
    border-radius: 4px;
    height: auto;
    text-align: center;
}
.fa-search {
    position: absolute;
    right: 10px;
    top: 18px;
}
    </style>

  </head>

  <body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-white bg-white fixed-top">
      <div class="container">
        <a class="navbar-brand" href="#">信用查询</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="#">服务说明</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <header>
      <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
        <ol class="carousel-indicators">
          <li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
          <li data-target="#carouselExampleIndicators" data-slide-to="1"></li>
          <li data-target="#carouselExampleIndicators" data-slide-to="2"></li>
        </ol>

        <div class="carousel-inner" role="listbox">
          <!-- Slide One - Set the background image for this slide in the line below -->
          <div class="carousel-item active" style="background-image: url('img/slider_one.jpg')">
          </div>
          <!-- Slide Two - Set the background image for this slide in the line below -->
          <div class="carousel-item" style="background-image: url('img/slider_two.jpg')">
          </div>
          <!-- Slide Three - Set the background image for this slide in the line below -->
          <div class="carousel-item" style="background-image: url('img/slider_three.jpg')">
          </div>
        </div>
        
        <div class="search_form">
          <div class="container">
              <h1 id="preview-textfield"></h1>
              <canvas width=380 height=150 id="canvas-preview"></canvas>
          </div>
          <div class="container">
            <span class="fa fa-search"></span>
            <h1 class="description">搜索一下<span>你的信用积分</span></h1>
          
            <div class="search-wraper" role="search">
              <div class="input-group">
                <input id="searchName" class="form-control search clearable" placeholder="搜索用户名，例如：tom" autocomplete="off" autofocus="" tabindex="0" autocorrect="off" autocapitalize="off" spellcheck="false"> 
                <div class="input-group-append">
                    <button id="searchCredit" class="btn btn-primary" style="box-shadow:none;border:none" type="button">搜索</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

      <div id="needCreate" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">系统提示</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p>没有找到该用户的信用积分，是否创建一个？</p>
            </div>
            <div class="modal-footer">
              <button type="button" id="jumpToCreate" data-toggle="modal" data-target="#createOne" data-dismiss="modal" class="btn btn-primary">创建</button>
              <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
            </div>
          </div>
        </div>
      </div>

      <div id="createOne" class="modal" tabindex="1" role="dialog">
          <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">创建信用积分</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                  <div class="form-group row">
                      <label for="userName" class="col-2 col-form-label">用户名称</label>
                      <div class="col-10">
                        <input class="form-control" type="text"  id="userName">
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="school" class="col-2 col-form-label">毕业学校</label>
                      <div class="col-10">
                        <input class="form-control" placeholder="xx大学/学院" type="text"  id="school">
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="driveLicence" class="col-2 col-form-label">驾照号</label>
                      <div class="col-10">
                        <input class="form-control" type="text"  id="driveLicence">
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="emailAddr" class="col-2 col-form-label">公司邮箱</label>
                      <div class="col-10">
                        <input class="form-control" placeholder="example@example.com" type="email" id="emailAddr">
                      </div>
                    </div>
                    <div class="form-group row">
                        <label for="fund" class="col-2 col-form-label">公积金</label>
                        <div class="col-10">
                          <input placeholder="单位（元）" class="form-control" type="number" id="fund">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="houseNumber" class="col-2 col-form-label">房产证号</label>
                        <div class="col-10">
                          <input class="form-control" type="text" id="houseNumber">
                        </div>
                    </div>
              </div>
              <div class="modal-footer">
                <button type="button" id="submitCreate" class="btn btn-primary">提交</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
              </div>
            </div>
          </div>
        </div>

    <!-- Footer -->
    <footer class="py-5 bg-white">
      <div class="container">
        <p class="m-0" style="color: #999" >Copyright &copy; powered by Levine and Gomez, all right reserved 2018</p>
      </div>
      <!-- /.container -->
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="vendor/gauge.min.js"></script>
    <script src=lib/nebPay.js></script>
    <script src=lib/nebulas.js></script>

    <script type="text/javascript">
      "use strict";
      var opts = {
        angle: 0.15, // The span of the gauge arc
        lineWidth: 0.44, // The line thickness
        radiusScale: 1, // Relative radius
        pointer: {
          length: 0.6, // // Relative to gauge radius
          strokeWidth: 0.035, // The thickness
          color: '#FFFFFF' // Fill color
        },
        limitMax: false,     // If false, max value increases automatically if value > maxValue
        limitMin: false,     // If true, the min value of the gauge will be fixed
        colorStart: '#6FADCF',   // Colors
        colorStop: '#1ADA87',    // just experiment with them
        strokeColor: '#E0E0E0',  // to see which ones work best for you
        generateGradient: true,
        highDpiSupport: true,     // High resolution support
        
      };
      var target = document.getElementById('canvas-preview'); // your canvas element
      var gauge = new Gauge(target).setOptions(opts); // create sexy gauge!
      gauge.setTextField(document.getElementById("preview-textfield"));
      gauge.maxValue = 3000; // set max gauge value
      gauge.setMinValue(0);  // Prefer setter over gauge.minValue = 0
      gauge.animationSpeed = 32; // set animation speed (32 is default value)
      gauge.set(0); // set actual value


      var dappAddress = "n1ptLwCEn8Areh9c9m7nvx6Qqspxn63Q1dQ";

      //here we use neb.js to call the "get" function to search from the Dictionary
      var nebulas = require("nebulas"),
          Account = nebulas.Account,
          neb = new nebulas.Neb();
      neb.setRequest(new nebulas.HttpRequest("https://testnet.nebulas.io"));

      var NebPay = require("nebpay");     //https://github.com/nebulasio/nebPay
      var nebPay = new NebPay();
      var serialNumber;
      var intervalQuery;

      function getValue(name, seed) {
            if(name != null && name != "" && name != undefined) {
              return Math.floor(Math.random() * 500) + seed;
            }
            return 0;
          }

      function funcIntervalQuery() {
        nebPay.queryPayInfo(serialNumber)   //search transaction result from server (result upload to server by app)
            .then(function (resp) {
                console.log("tx result: " + resp);   //resp is a JSON string
                var respObject = JSON.parse(resp);
                if(respObject.code === 0){
                    alert("upload succeed!");
                    clearInterval(intervalQuery);
                }
            })
            .catch(function (err) {
                console.log(err);
            });
    }

      function saveResult(key, value) {
        var to = dappAddress;
        var val = "0";
        var callFunction = "save";
        var callArgs = "[\"" + key + "\",\"" + value + "\"]";

        serialNumber = nebPay.call(to, val, callFunction, callArgs, {    //使用nebpay的call接口去调用合约,
            // 处理返回结果
            listener: function(resp) {
              console.log("response of push: " + JSON.stringify(resp))
            }
        });

        intervalQuery = setInterval(function () {
            funcIntervalQuery();
        }, 5000);
      }

      function getResult(keyName) {
        var from = Account.NewAccount().getAddressString();
        var value = "0";
        var nonce = "0";
        var gas_price = "1000000";
        var gas_limit = "2000000";
        var callFunction = "get";
        var callArgs = "[\"" + keyName + "\"]"; //in the form of ["args"]
        var contract = {
            "function": callFunction,
            "args": callArgs
        };

        nebPay.simulateCall(dappAddress, 0, callFunction, callArgs, {
          listener:function (resp) {
            var result = resp.result;    ////resp is an object, resp.result is a JSON string
            console.log("return of rpc call: " + JSON.stringify(result))
            $("#searchCredit").text("搜索");

            if (result === 'null'){
              $("#needCreate").modal();
            } else {
              try{
                result = JSON.parse(result)
              }catch (err){
                //result is the error message
                console.log("error:" + err.message)
              }

              // used fake result
//              gauge.set(getValue("test", 100));
              gauge.set(result.value);
            }

          }
        });
//        neb.api.call(from,dappAddress,value,nonce,gas_price,gas_limit,contract).then(function (resp) {
//          var result = resp.result    ////resp is an object, resp.result is a JSON string
//          console.log("return of rpc call: " + JSON.stringify(result))
//          $("#searchCredit").text("搜索");
//
//          if (result === 'null'){
//            $("#needCreate").modal();
//          } else {
//            try{
//                result = JSON.parse(result)
//            }catch (err){
//                //result is the error message
//                console.log("error:" + err.message)
//            }
//
//            // used fake result
//            gauge.set(getValue("test", 100));
//          }
//
//        }).catch(function (err) {
//            //cbSearch(err)
//            console.log("error:" + err.message)
//        })
      }

      $(document).ready(function() {
        $('.carousel').carousel({
          interval: 5000
        });

        $("#searchCredit").click(function() {

          $(this).text("正在搜索...");
          
          $("#createOne")
            .find("input,textarea,select")
              .val('')
              .end()
            .find("input[type=checkbox], input[type=radio]")
              .prop("checked", "")
              .end();
          var name = $("#searchName").val();
          $("#userName").val(name);
          if(name != "") {
            getResult(name);
          } else {
            $("#searchCredit").text("搜索");
            $("#needCreate").modal();
          }
        });

        $("#submitCreate").click(function() {
          var name = $("#userName").val();
          var school = $('#school').val();
          var drive = $("#driveLicence").val();
          var addr = $("#emailAddr").val();
          var fund = $("#fund").val();
          var house = $("#houseNumber").val();
          console.log(name, school, drive, addr, fund, house);

          if(name != null && name != "" && name != undefined) {
            var value = 100;
            value += getValue(school, 10);
            value += getValue(drive, 20);
            value += getValue(addr, 5);
            value += getValue(fund, 50);
            value += getValue(house, 30);
            console.log(value);
            gauge.set(value);
            $("#createOne").modal("hide");

            saveResult(name, value);
          }
        })
      });
    </script>

  </body>

</html>
